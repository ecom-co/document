"use strict";(self.webpackChunktemplate_docs=self.webpackChunktemplate_docs||[]).push([[7068],{28453:(e,n,l)=>{l.d(n,{R:()=>d,x:()=>t});var r=l(96540);const i={},s=r.createContext(i);function d(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),r.createElement(s.Provider,{value:n},e.children)}},85222:(e,n,l)=>{l.r(n),l.d(n,{assets:()=>a,contentTitle:()=>t,default:()=>u,frontMatter:()=>d,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"overview/middleware","title":"Middleware","description":"T\xecm hi\u1ec3u v\u1ec1 Middleware - c\xe1ch NestJS x\u1eed l\xfd request tr\u01b0\u1edbc khi \u0111\u1ebfn controller","source":"@site/docs/overview/middleware.md","sourceDirName":"overview","slug":"/overview/middleware","permalink":"/document/vi/docs/overview/middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/ecom-co/document/tree/main/docs/overview/middleware.md","tags":[],"version":"current","frontMatter":{"title":"Middleware","description":"T\xecm hi\u1ec3u v\u1ec1 Middleware - c\xe1ch NestJS x\u1eed l\xfd request tr\u01b0\u1edbc khi \u0111\u1ebfn controller"},"sidebar":"tutorialSidebar","previous":{"title":"Request Lifecycle","permalink":"/document/vi/docs/overview/request-lifecycle"},"next":{"title":"Guards","permalink":"/document/vi/docs/overview/guards"}}');var i=l(74848),s=l(28453);const d={title:"Middleware",description:"T\xecm hi\u1ec3u v\u1ec1 Middleware - c\xe1ch NestJS x\u1eed l\xfd request tr\u01b0\u1edbc khi \u0111\u1ebfn controller"},t="Middleware",a={},o=[{value:"Middleware l\xe0 g\xec?",id:"middleware-l\xe0-g\xec",level:2},{value:"C\xe1c lo\u1ea1i Middleware",id:"c\xe1c-lo\u1ea1i-middleware",level:2},{value:"1. Global Middleware",id:"1-global-middleware",level:3},{value:"2. Module Middleware",id:"2-module-middleware",level:3},{value:"3. Route Middleware",id:"3-route-middleware",level:3},{value:"T\u1ea1o Middleware c\u01a1 b\u1ea3n",id:"t\u1ea1o-middleware-c\u01a1-b\u1ea3n",level:2},{value:"C\u1ea5u tr\xfac Middleware",id:"c\u1ea5u-tr\xfac-middleware",level:2},{value:"Request Processing",id:"request-processing",level:3},{value:"Next Function",id:"next-function",level:3},{value:"Response Processing",id:"response-processing",level:3},{value:"S\u1eed d\u1ee5ng Middleware",id:"s\u1eed-d\u1ee5ng-middleware",level:2},{value:"Global Middleware",id:"global-middleware",level:3},{value:"Module Middleware",id:"module-middleware",level:3},{value:"Route Middleware",id:"route-middleware",level:3},{value:"Middleware Order",id:"middleware-order",level:2},{value:"Common Middleware Examples",id:"common-middleware-examples",level:2},{value:"1. Logging Middleware",id:"1-logging-middleware",level:3},{value:"2. Authentication Middleware",id:"2-authentication-middleware",level:3},{value:"3. Validation Middleware",id:"3-validation-middleware",level:3},{value:"Middleware vs Guards vs Interceptors",id:"middleware-vs-guards-vs-interceptors",level:2},{value:"Middleware",id:"middleware-1",level:3},{value:"Guards",id:"guards",level:3},{value:"Interceptors",id:"interceptors",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Middleware Order",id:"1-middleware-order",level:3},{value:"2. Error Handling",id:"2-error-handling",level:3},{value:"3. Performance",id:"3-performance",level:3},{value:"Testing Middleware",id:"testing-middleware",level:2},{value:"Unit Testing",id:"unit-testing",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"middleware",children:"Middleware"})}),"\n",(0,i.jsx)(n.p,{children:'Middleware trong NestJS l\xe0 c\xe1c functions \u0111\u01b0\u1ee3c th\u1ef1c thi tr\u01b0\u1edbc khi request \u0111\u1ebfn controller. Ch\xfang gi\u1ed1ng nh\u01b0 c\xe1c "b\u1ed9 l\u1ecdc" x\u1eed l\xfd request theo th\u1ee9 t\u1ef1 v\xe0 c\xf3 th\u1ec3 thay \u0111\u1ed5i request ho\u1eb7c response.'}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart LR\n    A[HTTP Request] --\x3e B[Middleware 1]\n    B --\x3e C[Middleware 2]\n    C --\x3e D[Middleware 3]\n    D --\x3e E[Controller]\n    E --\x3e F[HTTP Response]\n    \n    subgraph Pipeline["Middleware Pipeline"]\n        B\n        C\n        D\n    end\n    \n    style A fill:#e3f2fd\n    style B fill:#f3e5f5\n    style C fill:#e8f5e8\n    style D fill:#fff3e0\n    style E fill:#fce4ec\n    style F fill:#e1f5fe\n    style Pipeline fill:#f9f9f9,stroke:#666,stroke-width:2px,stroke-dasharray: 5 5'}),"\n",(0,i.jsx)(n.admonition,{title:"\ud83d\udca1 Kh\xe1i ni\u1ec7m c\u01a1 b\u1ea3n",type:"tip",children:(0,i.jsx)(n.p,{children:'Middleware gi\u1ed1ng nh\u01b0 m\u1ed9t "d\xe2y chuy\u1ec1n x\u1eed l\xfd" request. M\u1ed7i middleware c\xf3 th\u1ec3 x\u1eed l\xfd request v\xe0 quy\u1ebft \u0111\u1ecbnh c\xf3 cho ph\xe9p request ti\u1ebfp t\u1ee5c hay kh\xf4ng.'})}),"\n",(0,i.jsx)(n.h2,{id:"middleware-l\xe0-g\xec",children:"Middleware l\xe0 g\xec?"}),"\n",(0,i.jsx)(n.p,{children:"Middleware trong NestJS:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Request Processing"})," - X\u1eed l\xfd request tr\u01b0\u1edbc khi \u0111\u1ebfn controller"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Order Matters"})," - Th\u1ee9 t\u1ef1 th\u1ef1c thi quan tr\u1ecdng"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Chain Execution"})," - Th\u1ef1c thi theo chu\u1ed7i"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Early Exit"})," - C\xf3 th\u1ec3 d\u1eebng request s\u1edbm"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Global & Local"})," - C\xf3 th\u1ec3 \xe1p d\u1ee5ng to\xe0n c\u1ee5c ho\u1eb7c c\u1ee5c b\u1ed9"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"c\xe1c-lo\u1ea1i-middleware",children:"C\xe1c lo\u1ea1i Middleware"}),"\n",(0,i.jsx)(n.mermaid,{value:"flowchart TD\n    A[Middleware Types] --\x3e B[Global Middleware]\n    A --\x3e C[Module Middleware]\n    A --\x3e D[Route Middleware]\n    \n    style A fill:#e3f2fd\n    style B fill:#f3e5f5\n    style C fill:#e8f5e8\n    style D fill:#fff3e0"}),"\n",(0,i.jsx)(n.h3,{id:"1-global-middleware",children:"1. Global Middleware"}),"\n",(0,i.jsx)(n.p,{children:"\xc1p d\u1ee5ng cho t\u1ea5t c\u1ea3 requests trong \u1ee9ng d\u1ee5ng"}),"\n",(0,i.jsx)(n.h3,{id:"2-module-middleware",children:"2. Module Middleware"}),"\n",(0,i.jsx)(n.p,{children:"\xc1p d\u1ee5ng cho t\u1ea5t c\u1ea3 routes trong m\u1ed9t module"}),"\n",(0,i.jsx)(n.h3,{id:"3-route-middleware",children:"3. Route Middleware"}),"\n",(0,i.jsx)(n.p,{children:"\xc1p d\u1ee5ng cho m\u1ed9t route c\u1ee5 th\u1ec3"}),"\n",(0,i.jsx)(n.h2,{id:"t\u1ea1o-middleware-c\u01a1-b\u1ea3n",children:"T\u1ea1o Middleware c\u01a1 b\u1ea3n"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Basic Middleware Example"',children:"import { Injectable, NestMiddleware } from '@nestjs/common';\nimport { Request, Response, NextFunction } from 'express';\n\n@Injectable()\nexport class LoggerMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: NextFunction) {\n    console.log(`Request to: ${req.method} ${req.url}`);\n    next();\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"c\u1ea5u-tr\xfac-middleware",children:"C\u1ea5u tr\xfac Middleware"}),"\n",(0,i.jsx)(n.mermaid,{value:"flowchart LR\n    A[Middleware] --\x3e B[Request Processing]\n    A --\x3e C[Next Function]\n    A --\x3e D[Response Processing]\n    \n    style A fill:#e3f2fd\n    style B fill:#f3e5f5\n    style C fill:#e8f5e8\n    style D fill:#fff3e0"}),"\n",(0,i.jsx)(n.h3,{id:"request-processing",children:"Request Processing"}),"\n",(0,i.jsx)(n.p,{children:"X\u1eed l\xfd request tr\u01b0\u1edbc khi chuy\u1ec3n ti\u1ebfp"}),"\n",(0,i.jsx)(n.h3,{id:"next-function",children:"Next Function"}),"\n",(0,i.jsx)(n.p,{children:"G\u1ecdi next() \u0111\u1ec3 chuy\u1ec3n sang middleware ti\u1ebfp theo"}),"\n",(0,i.jsx)(n.h3,{id:"response-processing",children:"Response Processing"}),"\n",(0,i.jsx)(n.p,{children:"X\u1eed l\xfd response sau khi controller th\u1ef1c thi"}),"\n",(0,i.jsx)(n.h2,{id:"s\u1eed-d\u1ee5ng-middleware",children:"S\u1eed d\u1ee5ng Middleware"}),"\n",(0,i.jsx)(n.h3,{id:"global-middleware",children:"Global Middleware"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Global Middleware Usage"',children:"// main.ts\napp.use(helmet());           // Security\napp.use(cors());            // CORS handling\napp.use(compression());     // Compression\napp.use(express.json());    // Body parsing\napp.use(logger);           // Logging\n"})}),"\n",(0,i.jsx)(n.h3,{id:"module-middleware",children:"Module Middleware"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Module Middleware Usage"',children:"// user.module.ts\n@Module({\n  // ... other config\n})\nexport class UserModule implements NestModule {\n  configure(consumer: MiddlewareConsumer) {\n    consumer\n      .apply(LoggerMiddleware)\n      .forRoutes('*');\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"route-middleware",children:"Route Middleware"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Route Middleware Usage"',children:"// user.module.ts\nconfigure(consumer: MiddlewareConsumer) {\n  consumer\n    .apply(AuthMiddleware)\n    .forRoutes('users');\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"middleware-order",children:"Middleware Order"}),"\n",(0,i.jsx)(n.mermaid,{value:"flowchart TD\n    A[Request] --\x3e B[Security Middleware]\n    B --\x3e C[Parsing Middleware]\n    C --\x3e D[Business Middleware]\n    D --\x3e E[Controller]\n    \n    style A fill:#e3f2fd\n    style B fill:#ffebee\n    style C fill:#fff3e0\n    style D fill:#e8f5e8\n    style E fill:#fce4ec"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Th\u1ee9 t\u1ef1 quan tr\u1ecdng:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Security"})," - Helmet, CORS, Rate limiting"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Parsing"})," - Body parsing, Cookie parsing"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Business"})," - Logging, Authentication, Validation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Controller"})," - X\u1eed l\xfd business logic"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"common-middleware-examples",children:"Common Middleware Examples"}),"\n",(0,i.jsx)(n.h3,{id:"1-logging-middleware",children:"1. Logging Middleware"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Logging Middleware"',children:"@Injectable()\nexport class LoggingMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: NextFunction) {\n    const start = Date.now();\n    \n    res.on('finish', () => {\n      const duration = Date.now() - start;\n      console.log(`${req.method} ${req.url} - ${res.statusCode} - ${duration}ms`);\n    });\n    \n    next();\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-authentication-middleware",children:"2. Authentication Middleware"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Authentication Middleware"',children:"@Injectable()\nexport class AuthMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: NextFunction) {\n    const token = req.headers.authorization;\n    \n    if (!token) {\n      return res.status(401).json({ message: 'No token provided' });\n    }\n    \n    // Validate token logic here\n    next();\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-validation-middleware",children:"3. Validation Middleware"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Validation Middleware"',children:"@Injectable()\nexport class ValidationMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: NextFunction) {\n    if (req.method === 'POST' && !req.body) {\n      return res.status(400).json({ message: 'Request body is required' });\n    }\n    \n    next();\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"middleware-vs-guards-vs-interceptors",children:"Middleware vs Guards vs Interceptors"}),"\n",(0,i.jsx)(n.mermaid,{value:"flowchart LR\n    A[Request] --\x3e B[Middleware]\n    B --\x3e C[Guards]\n    C --\x3e D[Interceptors]\n    D --\x3e E[Controller]\n    \n    style A fill:#e3f2fd\n    style B fill:#f3e5f5\n    style C fill:#e8f5e8\n    style D fill:#fff3e0\n    style E fill:#fce4ec"}),"\n",(0,i.jsx)(n.h3,{id:"middleware-1",children:"Middleware"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Timing"}),": Tr\u01b0\u1edbc Guards"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Purpose"}),": Request processing, logging, CORS"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Scope"}),": Global, module, route level"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"guards",children:"Guards"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Timing"}),": Sau Middleware, tr\u01b0\u1edbc Interceptors"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Purpose"}),": Authentication, authorization"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Scope"}),": Controller, method level"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"interceptors",children:"Interceptors"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Timing"}),": Tr\u01b0\u1edbc v\xe0 sau Controller"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Purpose"}),": Transformation, logging, caching"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Scope"}),": Global, controller, method level"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(n.h3,{id:"1-middleware-order",children:"1. Middleware Order"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Middleware Order Best Practice"',children:"// \u2705 T\u1ed1t - Th\u1ee9 t\u1ef1 logic\napp.use(helmet());           // Security first\napp.use(cors());            // CORS handling\napp.use(compression());     // Compression\napp.use(express.json());    // Body parsing\napp.use(logger);           // Logging last\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-error-handling",children:"2. Error Handling"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Error Handling Best Practice"',children:"// \u2705 T\u1ed1t - X\u1eed l\xfd l\u1ed7i trong middleware\n@Injectable()\nexport class ErrorMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: NextFunction) {\n    try {\n      next();\n    } catch (error) {\n      console.error('Middleware error:', error);\n      res.status(500).json({ message: 'Internal server error' });\n    }\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-performance",children:"3. Performance"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Performance Best Practice"',children:"// \u2705 T\u1ed1t - Middleware nh\u1eb9 v\xe0 nhanh\n@Injectable()\nexport class FastMiddleware implements NestMiddleware {\n  use(req: Request, res: Response, next: NextFunction) {\n    // Ch\u1ec9 x\u1eed l\xfd c\u1ea7n thi\u1ebft\n    if (req.headers['x-skip-logging']) {\n      return next();\n    }\n    \n    console.log(`${req.method} ${req.url}`);\n    next();\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"testing-middleware",children:"Testing Middleware"}),"\n",(0,i.jsx)(n.h3,{id:"unit-testing",children:"Unit Testing"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="Middleware Unit Testing"',children:"describe('LoggerMiddleware', () => {\n  let middleware: LoggerMiddleware;\n  let mockRequest: Partial<Request>;\n  let mockResponse: Partial<Response>;\n  let nextFunction: NextFunction;\n\n  beforeEach(() => {\n    middleware = new LoggerMiddleware();\n    mockRequest = { method: 'GET', url: '/users' };\n    mockResponse = {};\n    nextFunction = jest.fn();\n  });\n\n  it('should log request and call next', () => {\n    const consoleSpy = jest.spyOn(console, 'log');\n    \n    middleware.use(mockRequest as Request, mockResponse as Response, nextFunction);\n    \n    expect(consoleSpy).toHaveBeenCalledWith('Request to: GET /users');\n    expect(nextFunction).toHaveBeenCalled();\n  });\n});\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.admonition,{title:"\ud83d\udca1 L\u1eddi khuy\xean t\u1ed5ng k\u1ebft",type:"tip",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"S\u1eed d\u1ee5ng middleware cho request processing, logging, CORS"}),"\n",(0,i.jsx)(n.li,{children:"Th\u1ee9 t\u1ef1 middleware r\u1ea5t quan tr\u1ecdng"}),"\n",(0,i.jsx)(n.li,{children:"Middleware n\xean nh\u1eb9 v\xe0 nhanh"}),"\n",(0,i.jsx)(n.li,{children:"S\u1eed d\u1ee5ng Guards cho authentication/authorization"}),"\n",(0,i.jsx)(n.li,{children:"S\u1eed d\u1ee5ng Interceptors cho transformation"}),"\n"]})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"B\xe0i ti\u1ebfp theo:"})," ",(0,i.jsx)(n.a,{href:"/docs/overview/guards",children:"Guards"})]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);