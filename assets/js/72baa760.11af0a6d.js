"use strict";(self.webpackChunktemplate_docs=self.webpackChunktemplate_docs||[]).push([[6433],{11470:(e,n,r)=>{r.d(n,{A:()=>C});var t=r(96540),i=r(34164),l=r(23104),s=r(56347),c=r(205),d=r(57485),o=r(31682),a=r(70679);function h(e){return t.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,t.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function p(e){const{values:n,children:r}=e;return(0,t.useMemo)(()=>{const e=n??function(e){return h(e).map(({props:{value:e,label:n,attributes:r,default:t}})=>({value:e,label:n,attributes:r,default:t}))}(r);return function(e){const n=(0,o.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,r])}function x({value:e,tabValues:n}){return n.some(n=>n.value===e)}function u({queryString:e=!1,groupId:n}){const r=(0,s.W6)(),i=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,d.aZ)(i),(0,t.useCallback)(e=>{if(!i)return;const n=new URLSearchParams(r.location.search);n.set(i,e),r.replace({...r.location,search:n.toString()})},[i,r])]}function j(e){const{defaultValue:n,queryString:r=!1,groupId:i}=e,l=p(e),[s,d]=(0,t.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!x({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const r=n.find(e=>e.default)??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:n,tabValues:l})),[o,h]=u({queryString:r,groupId:i}),[j,g]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[r,i]=(0,a.Dv)(n);return[r,(0,t.useCallback)(e=>{n&&i.set(e)},[n,i])]}({groupId:i}),m=(()=>{const e=o??j;return x({value:e,tabValues:l})?e:null})();(0,c.A)(()=>{m&&d(m)},[m]);return{selectedValue:s,selectValue:(0,t.useCallback)(e=>{if(!x({value:e,tabValues:l}))throw new Error(`Can't select invalid tab value=${e}`);d(e),h(e),g(e)},[h,g,l]),tabValues:l}}var g=r(92303);const m={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var v=r(74848);function E({className:e,block:n,selectedValue:r,selectValue:t,tabValues:s}){const c=[],{blockElementScrollPositionUntilNextRender:d}=(0,l.a_)(),o=e=>{const n=e.currentTarget,i=c.indexOf(n),l=s[i].value;l!==r&&(d(n),t(l))},a=e=>{let n=null;switch(e.key){case"Enter":o(e);break;case"ArrowRight":{const r=c.indexOf(e.currentTarget)+1;n=c[r]??c[0];break}case"ArrowLeft":{const r=c.indexOf(e.currentTarget)-1;n=c[r]??c[c.length-1];break}}n?.focus()};return(0,v.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":n},e),children:s.map(({value:e,label:n,attributes:t})=>(0,v.jsx)("li",{role:"tab",tabIndex:r===e?0:-1,"aria-selected":r===e,ref:e=>{c.push(e)},onKeyDown:a,onClick:o,...t,className:(0,i.A)("tabs__item",m.tabItem,t?.className,{"tabs__item--active":r===e}),children:n??e},e))})}function f({lazy:e,children:n,selectedValue:r}){const l=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=l.find(e=>e.props.value===r);return e?(0,t.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,v.jsx)("div",{className:"margin-top--md",children:l.map((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==r}))})}function b(e){const n=j(e);return(0,v.jsxs)("div",{className:(0,i.A)("tabs-container",m.tabList),children:[(0,v.jsx)(E,{...n,...e}),(0,v.jsx)(f,{...n,...e})]})}function C(e){const n=(0,g.A)();return(0,v.jsx)(b,{...e,children:h(e.children)},String(n))}},19365:(e,n,r)=>{r.d(n,{A:()=>s});r(96540);var t=r(34164);const i={tabItem:"tabItem_Ymn6"};var l=r(74848);function s({children:e,hidden:n,className:r}){return(0,l.jsx)("div",{role:"tabpanel",className:(0,t.A)(i.tabItem,r),hidden:n,children:e})}},28453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>c});var t=r(96540);const i={},l=t.createContext(i);function s(e){const n=t.useContext(l);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(l.Provider,{value:n},e.children)}},59414:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>x,frontMatter:()=>d,metadata:()=>t,toc:()=>h});const t=JSON.parse('{"id":"ecom-co/libs/grpc/docs/grpc-client-exception-filter","title":"GrpcClientFilter \u2014 Map GrpcClientException \u2192 HTTP response","description":"Exception filter chuy\u1ec3n GrpcClientException th\xe0nh HTTP response nh\u1ea5t qu\xe1n v\u1edbi ph\xe2n lo\u1ea1i status v\xe0 payload chi ti\u1ebft.","source":"@site/docs/ecom-co/libs/grpc/docs/grpc-client-exception-filter.md","sourceDirName":"ecom-co/libs/grpc/docs","slug":"/grpc-client-exception-filter","permalink":"/document/docs/grpc-client-exception-filter","draft":false,"unlisted":false,"editUrl":"https://github.com/ecom-co/document/tree/main/docs/ecom-co/libs/grpc/docs/grpc-client-exception-filter.md","tags":[{"inline":true,"label":"grpc","permalink":"/document/docs/tags/grpc"},{"inline":true,"label":"nestjs","permalink":"/document/docs/tags/nestjs"},{"inline":true,"label":"exception","permalink":"/document/docs/tags/exception"},{"inline":true,"label":"filter","permalink":"/document/docs/tags/filter"},{"inline":true,"label":"http","permalink":"/document/docs/tags/http"},{"inline":true,"label":"validation","permalink":"/document/docs/tags/validation"}],"version":"current","frontMatter":{"id":"grpc-client-exception-filter","title":"GrpcClientFilter \u2014 Map GrpcClientException \u2192 HTTP response","sidebar_label":"GrpcClientFilter","slug":"/grpc-client-exception-filter","description":"Exception filter chuy\u1ec3n GrpcClientException th\xe0nh HTTP response nh\u1ea5t qu\xe1n v\u1edbi ph\xe2n lo\u1ea1i status v\xe0 payload chi ti\u1ebft.","tags":["grpc","nestjs","exception","filter","http","validation"]},"sidebar":"tutorialSidebar","previous":{"title":"gRPC Utilities","permalink":"/document/docs/grpc-utilities"},"next":{"title":"gRPC Exceptions","permalink":"/document/docs/grpc-exceptions"}}');var i=r(74848),l=r(28453),s=r(11470),c=r(19365);const d={id:"grpc-client-exception-filter",title:"GrpcClientFilter \u2014 Map GrpcClientException \u2192 HTTP response",sidebar_label:"GrpcClientFilter",slug:"/grpc-client-exception-filter",description:"Exception filter chuy\u1ec3n GrpcClientException th\xe0nh HTTP response nh\u1ea5t qu\xe1n v\u1edbi ph\xe2n lo\u1ea1i status v\xe0 payload chi ti\u1ebft.",tags:["grpc","nestjs","exception","filter","http","validation"]},o=void 0,a={},h=[{value:"T\xednh n\u0103ng ch\xednh",id:"t\xednh-n\u0103ng-ch\xednh",level:3},{value:"C\xe1ch ho\u1ea1t \u0111\u1ed9ng",id:"c\xe1ch-ho\u1ea1t-\u0111\u1ed9ng",level:3},{value:"Options",id:"options",level:3},{value:"Mapping gRPC \u2192 HTTP",id:"mapping-grpc--http",level:3},{value:"Response payload",id:"response-payload",level:3},{value:"S\u1eed d\u1ee5ng trong NestJS",id:"s\u1eed-d\u1ee5ng-trong-nestjs",level:3},{value:"Mermaid: Flow x\u1eed l\xfd exception",id:"mermaid-flow-x\u1eed-l\xfd-exception",level:3},{value:"Best practices",id:"best-practices",level:3},{value:"Mode (http | grpc)",id:"mode-http--grpc",level:2},{value:"Sequence Diagram (http | grpc)",id:"sequence-diagram-http--grpc",level:3}];function p(e){const n={admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"GrpcClientFilter"})," l\xe0 ",(0,i.jsx)(n.code,{children:"@Catch(GrpcClientException)"})," d\xf9ng \u1edf HTTP layer. N\xf3 nh\u1eadn l\u1ed7i chu\u1ea9n t\u1eeb ",(0,i.jsx)(n.code,{children:"WrappedGrpc"})," v\xe0 \xe1nh x\u1ea1 sang HTTP status + body nh\u1ea5t qu\xe1n, c\xf3 h\u1ed7 tr\u1ee3 validation error, logging chi ti\u1ebft v\xe0 metadata."]})}),"\n",(0,i.jsx)(n.h3,{id:"t\xednh-n\u0103ng-ch\xednh",children:"T\xednh n\u0103ng ch\xednh"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Mapping gRPC status \u2192 HTTP status"})," (v\xed d\u1ee5 ",(0,i.jsx)(n.code,{children:"UNAVAILABLE"})," \u2192 ",(0,i.jsx)(n.code,{children:"503"}),", ",(0,i.jsx)(n.code,{children:"INVALID_ARGUMENT"})," \u2192 ",(0,i.jsx)(n.code,{children:"400"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"H\u1ed7 tr\u1ee3 validation"}),": n\u1ebfu ",(0,i.jsx)(n.code,{children:"INVALID_ARGUMENT"})," v\xe0 ",(0,i.jsx)(n.code,{children:"details"})," l\xe0 JSON, t\xe1ch ",(0,i.jsx)(n.code,{children:"errors"})," v\xe0 ",(0,i.jsx)(n.code,{children:"fieldErrors"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Logging linh ho\u1ea1t"}),": level ",(0,i.jsx)(n.code,{children:"debug"}),"/",(0,i.jsx)(n.code,{children:"warn"}),"/",(0,i.jsx)(n.code,{children:"error"}),", t\xf9y ch\u1ecdn stack trace, metadata, dev mode."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"T\xf9y bi\u1ebfn runtime"}),": ",(0,i.jsx)(n.code,{children:"updateOptions()"})," \u0111\u1ec3 \u0111\u1ed5i behavior khi \u0111ang ch\u1ea1y."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"c\xe1ch-ho\u1ea1t-\u0111\u1ed9ng",children:"C\xe1ch ho\u1ea1t \u0111\u1ed9ng"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n  participant H as HTTP Controller\n  participant F as GrpcClientFilter\n  participant E as GrpcClientException\n\n  H->>H: G\u1ecdi service qua WrappedGrpc\n  H--\x3e>H: throw GrpcClientException (E)\n  H->>F: Filter b\u1eaft E\n  F->>F: convertGrpcError() \u2192 handleGrpcStatusError()\n  F->>H: response.status(status).json(payload)"}),"\n",(0,i.jsx)(n.h3,{id:"options",children:"Options"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Option"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"M\u1eb7c \u0111\u1ecbnh"}),(0,i.jsx)(n.th,{children:"M\xf4 t\u1ea3"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"defaultErrorMessage"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"string"})}),(0,i.jsx)(n.td,{children:'"An unexpected error occurred"'}),(0,i.jsx)(n.td,{children:"Th\xf4ng \u0111i\u1ec7p chung khi kh\xf4ng expose l\u1ed7i n\u1ed9i b\u1ed9."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"enableDetailedLogging"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"boolean"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"true"})}),(0,i.jsx)(n.td,{children:"B\u1eadt log chi ti\u1ebft (bao g\u1ed3m details keys/type...)."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"enableStackTrace"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"boolean"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"false"})}),(0,i.jsx)(n.td,{children:"Log k\xe8m stack trace."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"exposeInternalErrors"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"boolean"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"false"})}),(0,i.jsx)(n.td,{children:"Cho ph\xe9p tr\u1ea3 message n\u1ed9i b\u1ed9 ra HTTP (prod n\xean \u0111\u1ec3 false)."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"includeMetadata"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"boolean"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"false"})}),(0,i.jsx)(n.td,{children:"Log k\xe8m gRPC metadata n\u1ebfu c\xf3."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"isDevelopment"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"boolean"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"false"})}),(0,i.jsxs)(n.td,{children:["Th\xeam tr\u01b0\u1eddng ",(0,i.jsx)(n.code,{children:"debug"})," trong response v\xe0 log raw details."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"logLevel"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"'debug'|'warn'|'error'"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"'error'"})}),(0,i.jsx)(n.td,{children:"M\u1ee9c log s\u1eed d\u1ee5ng khi ghi log."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"mode"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"'http'|'grpc'"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"'http'"})}),(0,i.jsx)(n.td,{children:"C\xe1ch x\u1eed l\xfd exception: map HTTP ho\u1eb7c rethrow gRPC."})]})]})]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"updateOptions(partial)"})," cho ph\xe9p thay \u0111\u1ed5i options khi runtime, v\xe0 ",(0,i.jsx)(n.code,{children:"getOptions()"})," tr\u1ea3 v\u1ec1 snapshot c\u1ea5u h\xecnh hi\u1ec7n t\u1ea1i."]})}),"\n",(0,i.jsx)(n.h3,{id:"mapping-grpc--http",children:"Mapping gRPC \u2192 HTTP"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"gRPC Code"}),(0,i.jsx)(n.th,{style:{textAlign:"right"},children:"HTTP Status"}),(0,i.jsx)(n.th,{children:"error"}),(0,i.jsx)(n.th,{children:"message"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ABORTED"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"409"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ABORTED"})}),(0,i.jsx)(n.td,{children:"Operation was aborted"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ALREADY_EXISTS"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"409"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ALREADY_EXISTS"})}),(0,i.jsx)(n.td,{children:"Resource already exists"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"CANCELLED"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"408"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"CANCELLED"})}),(0,i.jsx)(n.td,{children:"Request was cancelled"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"DATA_LOSS"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"500"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"DATA_LOSS"})}),(0,i.jsx)(n.td,{children:"Data loss detected"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"DEADLINE_EXCEEDED"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"408"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"DEADLINE_EXCEEDED"})}),(0,i.jsx)(n.td,{children:"Request deadline exceeded"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"FAILED_PRECONDITION"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"412"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"FAILED_PRECONDITION"})}),(0,i.jsx)(n.td,{children:"Failed precondition"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"INTERNAL"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"500"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"INTERNAL"})}),(0,i.jsx)(n.td,{children:"defaultErrorMessage ho\u1eb7c details n\u1ebfu exposeInternalErrors"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"INVALID_ARGUMENT"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"400"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"INVALID_ARGUMENT"})," ho\u1eb7c ",(0,i.jsx)(n.code,{children:"VALIDATION_ERROR"})]}),(0,i.jsxs)(n.td,{children:["T\xe1ch ",(0,i.jsx)(n.code,{children:"errors"}),"/",(0,i.jsx)(n.code,{children:"fieldErrors"})," n\u1ebfu ",(0,i.jsx)(n.code,{children:"details"})," l\xe0 JSON"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"NOT_FOUND"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"404"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"NOT_FOUND"})}),(0,i.jsx)(n.td,{children:"Resource not found"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"OUT_OF_RANGE"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"400"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"OUT_OF_RANGE"})}),(0,i.jsx)(n.td,{children:"Value out of range"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"PERMISSION_DENIED"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"403"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"PERMISSION_DENIED"})}),(0,i.jsx)(n.td,{children:"Permission denied"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"RESOURCE_EXHAUSTED"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"429"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"RESOURCE_EXHAUSTED"})}),(0,i.jsx)(n.td,{children:"Resource exhausted"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNAUTHENTICATED"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"401"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNAUTHENTICATED"})}),(0,i.jsx)(n.td,{children:"Authentication required"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNAVAILABLE"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"503"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNAVAILABLE"})}),(0,i.jsx)(n.td,{children:"Service unavailable"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNIMPLEMENTED"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"501"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNIMPLEMENTED"})}),(0,i.jsx)(n.td,{children:"Method not implemented"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNKNOWN"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"500"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNKNOWN"})}),(0,i.jsx)(n.td,{children:"defaultErrorMessage ho\u1eb7c details n\u1ebfu exposeInternalErrors"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNKNOWN_GRPC_CODE"})}),(0,i.jsx)(n.td,{style:{textAlign:"right"},children:"500"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"UNKNOWN_GRPC_CODE"})}),(0,i.jsx)(n.td,{children:"defaultErrorMessage ho\u1eb7c chi ti\u1ebft code l\u1ea1"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"response-payload",children:"Response payload"}),"\n",(0,i.jsx)(n.p,{children:"Payload chu\u1ea9n tr\u1ea3 v\u1ec1 b\u1edfi filter:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n    "statusCode": 400,\n    "error": "VALIDATION_ERROR",\n    "message": "Validation failed",\n    "errors": ["email must be an email"],\n    "fieldErrors": { "email": { "isEmail": "email must be an email" } },\n    "path": "/v1/users",\n    "timestamp": "2024-05-01T10:00:00.000Z",\n    "details": "...", // optional\n    "debug": {\n        // ch\u1ec9 khi isDevelopment = true\n        "grpcCode": 3,\n        "originalError": "INVALID_ARGUMENT: ...",\n        "stackTrace": "..."\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"s\u1eed-d\u1ee5ng-trong-nestjs",children:"S\u1eed d\u1ee5ng trong NestJS"}),"\n",(0,i.jsxs)(s.A,{children:[(0,i.jsx)(c.A,{value:"global",label:"Global Filter Setup",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// main.ts\nimport { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\nimport { GrpcClientFilter } from '@ecom-co/grpc';\n\nasync function bootstrap() {\n    const app = await NestFactory.create(AppModule);\n\n    // Setup global filter\n    app.useGlobalFilters(\n        new GrpcClientFilter({\n            enableDetailedLogging: true,\n            logLevel: 'error',\n            isDevelopment: process.env.NODE_ENV !== 'production',\n            exposeInternalErrors: process.env.NODE_ENV !== 'production',\n            enableStackTrace: process.env.NODE_ENV !== 'production',\n            includeMetadata: true,\n        }),\n    );\n\n    await app.listen(3000);\n}\nbootstrap();\n"})})}),(0,i.jsx)(c.A,{value:"module",label:"Module Provider",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// app.module.ts\nimport { Module } from '@nestjs/common';\nimport { APP_FILTER } from '@nestjs/core';\nimport { GrpcClientFilter } from '@ecom-co/grpc';\n\n@Module({\n    providers: [\n        {\n            provide: APP_FILTER,\n            useFactory: () =>\n                new GrpcClientFilter({\n                    enableDetailedLogging: process.env.NODE_ENV !== 'production',\n                    logLevel: (process.env.LOG_LEVEL as any) || 'error',\n                    isDevelopment: process.env.NODE_ENV === 'development',\n                    exposeInternalErrors: false, // Lu\xf4n false trong production\n                }),\n        },\n    ],\n})\nexport class AppModule {}\n"})})}),(0,i.jsx)(c.A,{value:"controller",label:"Per Controller",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// users.controller.ts\nimport { Controller, Get, Post, Body, Param, UseFilters } from '@nestjs/common';\nimport { GrpcClientFilter } from '@ecom-co/grpc';\nimport { UserService } from './user.service';\n\n@UseFilters(\n    new GrpcClientFilter({\n        exposeInternalErrors: false,\n        enableDetailedLogging: true,\n    }),\n)\n@Controller('users')\nexport class UsersController {\n    constructor(private readonly userService: UserService) {}\n\n    @Get(':id')\n    async getUser(@Param('id') id: string) {\n        // N\u1ebfu UserService throw GrpcClientException, filter s\u1ebd x\u1eed l\xfd\n        return this.userService.findById(id);\n    }\n\n    @Post()\n    async createUser(@Body() userData: any) {\n        return this.userService.create(userData);\n    }\n}\n"})})}),(0,i.jsx)(c.A,{value:"scenarios",label:"Error Scenarios",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// C\xe1c t\xecnh hu\u1ed1ng l\u1ed7i th\u01b0\u1eddng g\u1eb7p v\xe0 c\xe1ch filter x\u1eed l\xfd\n\n// 1. Validation Error (INVALID_ARGUMENT v\u1edbi JSON details)\n// gRPC tr\u1ea3 v\u1ec1:\n// code: 3 (INVALID_ARGUMENT)\n// details: \'{"errors":["email must be valid"],"fieldErrors":{"email":{"isEmail":"email must be valid"}}}\'\n//\n// HTTP Response:\n// {\n//   "statusCode": 400,\n//   "error": "VALIDATION_ERROR",\n//   "message": "Validation failed",\n//   "errors": ["email must be valid"],\n//   "fieldErrors": {"email": {"isEmail": "email must be valid"}},\n//   "path": "/users",\n//   "timestamp": "2024-05-01T10:00:00.000Z"\n// }\n\n// 2. Not Found (NOT_FOUND)\n// gRPC: code: 5, details: "User with id 123 not found"\n// HTTP: 404 v\u1edbi message t\u01b0\u01a1ng \u1ee9ng\n\n// 3. Service Unavailable (UNAVAILABLE)\n// gRPC: code: 14, details: "Service temporarily unavailable"\n// HTTP: 503 Service Unavailable\n\n// 4. Authentication Required (UNAUTHENTICATED)\n// gRPC: code: 16, details: "Invalid token"\n// HTTP: 401 Unauthorized\n\n// 5. Internal Error (INTERNAL) - Production\n// gRPC: code: 13, details: "Database connection failed"\n// HTTP: 500 v\u1edbi generic message (kh\xf4ng expose chi ti\u1ebft)\n'})})}),(0,i.jsx)(c.A,{value:"runtime",label:"Runtime Configuration",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// service.ts - C\u1eadp nh\u1eadt options khi runtime\nimport { Injectable } from '@nestjs/common';\nimport { GrpcClientFilter } from '@ecom-co/grpc';\n\n@Injectable()\nexport class ConfigService {\n    constructor(private readonly grpcFilter: GrpcClientFilter) {}\n\n    enableDebugMode() {\n        this.grpcFilter.updateOptions({\n            isDevelopment: true,\n            enableStackTrace: true,\n            logLevel: 'debug',\n        });\n    }\n\n    setProductionMode() {\n        this.grpcFilter.updateOptions({\n            isDevelopment: false,\n            enableStackTrace: false,\n            exposeInternalErrors: false,\n            logLevel: 'error',\n        });\n    }\n\n    getCurrentConfig() {\n        return this.grpcFilter.getOptions();\n    }\n}\n"})})}),(0,i.jsx)(c.A,{value:"testing",label:"Testing v\u1edbi Filter",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// user.controller.spec.ts\nimport { Test, TestingModule } from '@nestjs/testing';\nimport { GrpcClientFilter, GrpcClientException } from '@ecom-co/grpc';\nimport { UsersController } from './users.controller';\nimport { UserService } from './user.service';\n\ndescribe('UsersController with GrpcClientFilter', () => {\n    let controller: UsersController;\n    let userService: UserService;\n    let filter: GrpcClientFilter;\n\n    beforeEach(async () => {\n        const module: TestingModule = await Test.createTestingModule({\n            controllers: [UsersController],\n            providers: [\n                {\n                    provide: UserService,\n                    useValue: {\n                        findById: jest.fn(),\n                        create: jest.fn(),\n                    },\n                },\n            ],\n        }).compile();\n\n        controller = module.get<UsersController>(UsersController);\n        userService = module.get<UserService>(UserService);\n        filter = new GrpcClientFilter({\n            isDevelopment: true,\n            enableDetailedLogging: false, // T\u1eaft log trong test\n        });\n    });\n\n    it('should handle NOT_FOUND error', async () => {\n        const exception = new GrpcClientException('User not found', 5);\n        jest.spyOn(userService, 'findById').mockRejectedValue(exception);\n\n        const mockResponse = {\n            status: jest.fn().mockReturnThis(),\n            json: jest.fn(),\n            headersSent: false,\n        };\n\n        const mockHost = {\n            switchToHttp: () => ({\n                getResponse: () => mockResponse,\n                getRequest: () => ({ url: '/users/123', method: 'GET' }),\n            }),\n        };\n\n        filter.catch(exception, mockHost as any);\n\n        expect(mockResponse.status).toHaveBeenCalledWith(404);\n        expect(mockResponse.json).toHaveBeenCalledWith(\n            expect.objectContaining({\n                statusCode: 404,\n                error: 'NOT_FOUND',\n                message: 'Resource not found',\n            }),\n        );\n    });\n});\n"})})})]}),"\n",(0,i.jsx)(n.h3,{id:"mermaid-flow-x\u1eed-l\xfd-exception",children:"Mermaid: Flow x\u1eed l\xfd exception"}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart TD\n  A[GrpcClientException] --\x3e B{mode}\n  B -- http --\x3e C{headersSent?}\n  C -- Yes --\x3e D[return]\n  C -- No --\x3e E[logException]\n  E --\x3e F[convertGrpcError]\n  F --\x3e G[handleGrpcStatusError]\n  G --\x3e H["response.status(...).json(...)"]\n  B -- grpc --\x3e I[toBaseGrpcException]\n  I --\x3e J[throw BaseGrpcException]'}),"\n",(0,i.jsx)(n.h3,{id:"best-practices",children:"Best practices"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Kh\xf4ng expose l\u1ed7i n\u1ed9i b\u1ed9"})," \u1edf production: ",(0,i.jsx)(n.code,{children:"exposeInternalErrors: false"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"B\u1eadt detailed logging"})," \u1edf staging/dev \u0111\u1ec3 debug nhanh."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u0110\u1ea3m b\u1ea3o WrappedGrpc"})," \u0111\u01b0\u1ee3c d\xf9ng \u1edf client \u0111\u1ec3 lu\xf4n n\xe9m ",(0,i.jsx)(n.code,{children:"GrpcClientException"})," chu\u1ea9n."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"mode-http--grpc",children:"Mode (http | grpc)"}),"\n",(0,i.jsx)(n.p,{children:"Granicular control for where the exception is handled:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"mode: 'http'"})," (m\u1eb7c \u0111\u1ecbnh): map ",(0,i.jsx)(n.code,{children:"GrpcClientException"})," \u2192 HTTP response (status + body) theo b\u1ea3ng Mapping gRPC \u2192 HTTP ph\xeda tr\xean."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"mode: 'grpc'"}),": chuy\u1ec3n ",(0,i.jsx)(n.code,{children:"GrpcClientException"})," th\xe0nh ",(0,i.jsx)(n.code,{children:"BaseGrpcException"})," t\u01b0\u01a1ng \u1ee9ng v\xe0 n\xe9m l\u1ea1i \u0111\u1ec3 Nest gRPC tr\u1ea3 v\u1ec1 gRPC status/payload chu\u1ea9n."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:'language-ts:title="HTTP',metastring:'mode (default)"',children:"app.useGlobalFilters(new GrpcClientFilter({\n  mode: 'http',\n  enableDetailedLogging: true,\n}));\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:'language-ts:title="gRPC',metastring:'mode (propagate native gRPC)"',children:"app.useGlobalFilters(new GrpcClientFilter({\n  mode: 'grpc',\n}));\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Note: ",(0,i.jsx)(n.code,{children:"WrappedGrpc"})," ch\u1ec9 n\xe9m ",(0,i.jsx)(n.code,{children:"GrpcClientException"}),". Vi\u1ec7c map sang HTTP ho\u1eb7c gRPC \u0111\u01b0\u1ee3c quy\u1ebft \u0111\u1ecbnh \u1edf filter qua ",(0,i.jsx)(n.code,{children:"mode"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"sequence-diagram-http--grpc",children:"Sequence Diagram (http | grpc)"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\n  participant Caller as Controller/Handler\n  participant Filter as GrpcClientFilter\n  participant E as GrpcClientException\n\n  Caller->>Caller: Call service via WrappedGrpc\n  Caller--\x3e>Caller: throw GrpcClientException (E)\n  Caller->>Filter: catch(E)\n  alt mode == http\n    Filter->>Filter: convertGrpcError()\n    Filter->>Filter: handleGrpcStatusError()\n    Filter--\x3e>Caller: response.status(...).json(...)\n  else mode == grpc\n    Filter->>Filter: toBaseGrpcException(E)\n    Filter--\x3e>Caller: throw BaseGrpcException\n  end"})]})}function x(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}}}]);