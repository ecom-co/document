"use strict";(self.webpackChunktemplate_docs=self.webpackChunktemplate_docs||[]).push([[6300],{11470:(e,r,n)=>{n.d(r,{A:()=>C});var t=n(96540),i=n(34164),c=n(23104),s=n(56347),l=n(205),o=n(57485),a=n(31682),d=n(70679);function h(e){return t.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,t.isValidElement)(e)&&function(e){const{props:r}=e;return!!r&&"object"==typeof r&&"value"in r}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function p(e){const{values:r,children:n}=e;return(0,t.useMemo)(()=>{const e=r??function(e){return h(e).map(({props:{value:e,label:r,attributes:n,default:t}})=>({value:e,label:r,attributes:n,default:t}))}(n);return function(e){const r=(0,a.XI)(e,(e,r)=>e.value===r.value);if(r.length>0)throw new Error(`Docusaurus error: Duplicate values "${r.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[r,n])}function u({value:e,tabValues:r}){return r.some(r=>r.value===e)}function x({queryString:e=!1,groupId:r}){const n=(0,s.W6)(),i=function({queryString:e=!1,groupId:r}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return r??null}({queryString:e,groupId:r});return[(0,o.aZ)(i),(0,t.useCallback)(e=>{if(!i)return;const r=new URLSearchParams(n.location.search);r.set(i,e),n.replace({...n.location,search:r.toString()})},[i,n])]}function g(e){const{defaultValue:r,queryString:n=!1,groupId:i}=e,c=p(e),[s,o]=(0,t.useState)(()=>function({defaultValue:e,tabValues:r}){if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!u({value:e,tabValues:r}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${r.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const n=r.find(e=>e.default)??r[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:r,tabValues:c})),[a,h]=x({queryString:n,groupId:i}),[g,m]=function({groupId:e}){const r=function(e){return e?`docusaurus.tab.${e}`:null}(e),[n,i]=(0,d.Dv)(r);return[n,(0,t.useCallback)(e=>{r&&i.set(e)},[r,i])]}({groupId:i}),j=(()=>{const e=a??g;return u({value:e,tabValues:c})?e:null})();(0,l.A)(()=>{j&&o(j)},[j]);return{selectedValue:s,selectValue:(0,t.useCallback)(e=>{if(!u({value:e,tabValues:c}))throw new Error(`Can't select invalid tab value=${e}`);o(e),h(e),m(e)},[h,m,c]),tabValues:c}}var m=n(92303);const j={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var v=n(74848);function b({className:e,block:r,selectedValue:n,selectValue:t,tabValues:s}){const l=[],{blockElementScrollPositionUntilNextRender:o}=(0,c.a_)(),a=e=>{const r=e.currentTarget,i=l.indexOf(r),c=s[i].value;c!==n&&(o(r),t(c))},d=e=>{let r=null;switch(e.key){case"Enter":a(e);break;case"ArrowRight":{const n=l.indexOf(e.currentTarget)+1;r=l[n]??l[0];break}case"ArrowLeft":{const n=l.indexOf(e.currentTarget)-1;r=l[n]??l[l.length-1];break}}r?.focus()};return(0,v.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":r},e),children:s.map(({value:e,label:r,attributes:t})=>(0,v.jsx)("li",{role:"tab",tabIndex:n===e?0:-1,"aria-selected":n===e,ref:e=>{l.push(e)},onKeyDown:d,onClick:a,...t,className:(0,i.A)("tabs__item",j.tabItem,t?.className,{"tabs__item--active":n===e}),children:r??e},e))})}function f({lazy:e,children:r,selectedValue:n}){const c=(Array.isArray(r)?r:[r]).filter(Boolean);if(e){const e=c.find(e=>e.props.value===n);return e?(0,t.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,v.jsx)("div",{className:"margin-top--md",children:c.map((e,r)=>(0,t.cloneElement)(e,{key:r,hidden:e.props.value!==n}))})}function y(e){const r=g(e);return(0,v.jsxs)("div",{className:(0,i.A)("tabs-container",j.tabList),children:[(0,v.jsx)(b,{...r,...e}),(0,v.jsx)(f,{...r,...e})]})}function C(e){const r=(0,m.A)();return(0,v.jsx)(y,{...e,children:h(e.children)},String(r))}},19365:(e,r,n)=>{n.d(r,{A:()=>s});n(96540);var t=n(34164);const i={tabItem:"tabItem_Ymn6"};var c=n(74848);function s({children:e,hidden:r,className:n}){return(0,c.jsx)("div",{role:"tabpanel",className:(0,t.A)(i.tabItem,n),hidden:r,children:e})}},28453:(e,r,n)=>{n.d(r,{R:()=>s,x:()=>l});var t=n(96540);const i={},c=t.createContext(i);function s(e){const r=t.useContext(c);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(c.Provider,{value:r},e.children)}},66386:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>h});const t=JSON.parse('{"id":"ecom-co/libs/grpc/docs/wrapped-grpc","title":"WrappedGrpc \u2014 Wrapper cho ClientGrpc (timeout, retry, logging)","description":"Wrapper ti\u1ec7n \xedch cho NestJS ClientGrpc v\u1edbi timeout, retry c\xf3 backoff, v\xe0 unified error handling.","source":"@site/docs/ecom-co/libs/grpc/docs/wrapped-grpc.md","sourceDirName":"ecom-co/libs/grpc/docs","slug":"/wrapped-grpc","permalink":"/document/docs/wrapped-grpc","draft":false,"unlisted":false,"editUrl":"https://github.com/ecom-co/document/tree/main/docs/ecom-co/libs/grpc/docs/wrapped-grpc.md","tags":[{"inline":true,"label":"grpc","permalink":"/document/docs/tags/grpc"},{"inline":true,"label":"nestjs","permalink":"/document/docs/tags/nestjs"},{"inline":true,"label":"client","permalink":"/document/docs/tags/client"},{"inline":true,"label":"retry","permalink":"/document/docs/tags/retry"},{"inline":true,"label":"timeout","permalink":"/document/docs/tags/timeout"},{"inline":true,"label":"logging","permalink":"/document/docs/tags/logging"},{"inline":true,"label":"rxjs","permalink":"/document/docs/tags/rxjs"}],"version":"current","frontMatter":{"id":"wrapped-grpc","title":"WrappedGrpc \u2014 Wrapper cho ClientGrpc (timeout, retry, logging)","sidebar_label":"WrappedGrpc","slug":"/wrapped-grpc","description":"Wrapper ti\u1ec7n \xedch cho NestJS ClientGrpc v\u1edbi timeout, retry c\xf3 backoff, v\xe0 unified error handling.","tags":["grpc","nestjs","client","retry","timeout","logging","rxjs"]},"sidebar":"tutorialSidebar","previous":{"title":"Proto Utils","permalink":"/document/docs/proto-utils"},"next":{"title":"GrpcValidationPipe","permalink":"/document/docs/grpc-validation-pipe"}}');var i=n(74848),c=n(28453),s=n(11470),l=n(19365);const o={id:"wrapped-grpc",title:"WrappedGrpc \u2014 Wrapper cho ClientGrpc (timeout, retry, logging)",sidebar_label:"WrappedGrpc",slug:"/wrapped-grpc",description:"Wrapper ti\u1ec7n \xedch cho NestJS ClientGrpc v\u1edbi timeout, retry c\xf3 backoff, v\xe0 unified error handling.",tags:["grpc","nestjs","client","retry","timeout","logging","rxjs"]},a=void 0,d={},h=[{value:"T\u1ed5ng quan",id:"t\u1ed5ng-quan",level:3},{value:"C\xe1ch ho\u1ea1t \u0111\u1ed9ng (t\xf3m t\u1eaft)",id:"c\xe1ch-ho\u1ea1t-\u0111\u1ed9ng-t\xf3m-t\u1eaft",level:3},{value:"Kh\u1edfi t\u1ea1o",id:"kh\u1edfi-t\u1ea1o",level:3},{value:"API surface",id:"api-surface",level:3},{value:"GrpcOptions",id:"grpcoptions",level:3},{value:"Error model: GrpcClientException",id:"error-model-grpcclientexception",level:3},{value:"V\xed d\u1ee5 s\u1eed d\u1ee5ng",id:"v\xed-d\u1ee5-s\u1eed-d\u1ee5ng",level:3},{value:"Logging &amp; sanitize args",id:"logging--sanitize-args",level:3},{value:"Mermaid: Retry &amp; Timeout pipeline",id:"mermaid-retry--timeout-pipeline",level:3},{value:"Best practices",id:"best-practices",level:3}];function p(e){const r={admonition:"admonition",code:"code",h3:"h3",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.admonition,{type:"info",children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"WrappedGrpc"})," l\xe0 m\u1ed9t l\u1edbp wrapper cho ",(0,i.jsx)(r.code,{children:"ClientGrpc"})," (NestJS) gi\xfap b\u1ea1n: log request c\xf3 sanitization, \xe1p ",(0,i.jsx)(r.code,{children:"timeout"}),", ",(0,i.jsx)(r.code,{children:"retry"})," theo ",(0,i.jsx)(r.code,{children:"retryableCodes"})," v\u1edbi exponential backoff cap, v\xe0 th\u1ed1ng nh\u1ea5t error th\xe0nh ",(0,i.jsx)(r.code,{children:"GrpcClientException"})," \u0111\u1ec3 filter HTTP c\xf3 th\u1ec3 x\u1eed l\xfd."]})}),"\n",(0,i.jsx)(r.h3,{id:"t\u1ed5ng-quan",children:"T\u1ed5ng quan"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"M\u1ee5c ti\xeau"}),": Chu\u1ea9n ho\xe1 c\xe1ch g\u1ecdi gRPC \u1edf Client, gi\u1ea3m l\u1eb7p v\xe0 t\u0103ng observability."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"\u0110i\u1ec3m n\u1ed5i b\u1eadt"}),":","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Logging"})," c\xf3 sanitize fields nh\u1ea1y c\u1ea3m (",(0,i.jsx)(r.code,{children:"password"}),", ",(0,i.jsx)(r.code,{children:"token"}),", ",(0,i.jsx)(r.code,{children:"secret"}),", ",(0,i.jsx)(r.code,{children:"key"}),")."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Timeout"}),": auto ",(0,i.jsx)(r.code,{children:"timeout(ms)"})," cho m\u1ed7i gRPC ",(0,i.jsx)(r.code,{children:"Observable"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Retry"}),": ",(0,i.jsx)(r.code,{children:"rxjs"})," retry v\u1edbi exponential backoff, ch\u1ec9 retry khi ",(0,i.jsx)(r.code,{children:"code"})," thu\u1ed9c ",(0,i.jsx)(r.code,{children:"retryableCodes"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Error chu\u1ea9n"}),": chuy\u1ec3n m\u1ecdi l\u1ed7i th\xe0nh ",(0,i.jsx)(r.code,{children:"GrpcClientException"})," (gi\xfap HTTP layer/filter x\u1eed l\xfd th\u1ed1ng nh\u1ea5t)."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"c\xe1ch-ho\u1ea1t-\u0111\u1ed9ng-t\xf3m-t\u1eaft",children:"C\xe1ch ho\u1ea1t \u0111\u1ed9ng (t\xf3m t\u1eaft)"}),"\n",(0,i.jsx)(r.mermaid,{value:'sequenceDiagram\n  participant C as Controller/Service (HTTP)\n  participant W as WrappedGrpc (Proxy)\n  participant G as ClientGrpc Service\n  C->>W: getService("UserService").getUser(args)\n  W->>G: g\u1ecdi method th\u1ef1c t\u1ebf (tr\u1ea3 v\u1ec1 Observable)\n  activate W\n  Note right of W: pipe(timeout) + pipe(retryIf code \u2208 retryableCodes) + catchError\n  G--\x3e>W: next/err complete\n  W--\x3e>C: data | throw GrpcClientException\n  deactivate W'}),"\n",(0,i.jsx)(r.admonition,{type:"tip",children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"WrappedGrpc"})," s\u1eed d\u1ee5ng ",(0,i.jsx)(r.code,{children:"Proxy"})," \u0111\u1ec3 intercept t\u1eebng method c\u1ee7a service \u0111\u01b0\u1ee3c tr\u1ea3 v\u1ec1 b\u1edfi ",(0,i.jsx)(r.code,{children:"clientGrpc.getService(name)"}),". N\u1ebfu method tr\u1ea3 v\u1ec1 ",(0,i.jsx)(r.code,{children:"Observable"}),", n\xf3 s\u1ebd t\u1ef1 \u0111\u1ed9ng wrap ",(0,i.jsx)(r.code,{children:"pipe()"})," v\u1edbi ",(0,i.jsx)(r.code,{children:"timeout"}),", ",(0,i.jsx)(r.code,{children:"retry"}),", v\xe0 ",(0,i.jsx)(r.code,{children:"catchError"}),"."]})}),"\n",(0,i.jsx)(r.h3,{id:"kh\u1edfi-t\u1ea1o",children:"Kh\u1edfi t\u1ea1o"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"import { ClientGrpc } from '@nestjs/microservices';\nimport { createWrappedGrpc, WrappedGrpc } from '@ecom-co/grpc';\n\nconstructor(@Inject('GRPC_CLIENT') private readonly clientGrpc: ClientGrpc) {\n  this.grpc = createWrappedGrpc(this.clientGrpc, {\n    enableLogging: true,\n    timeout: 30000,\n    retry: 2,\n    maxRetryDelay: 10000,\n    retryableCodes: [1, 4, 8, 10, 13, 14, 15],\n  });\n}\n\nconst userService = this.grpc.getService<UserService>('UserService');\n"})}),"\n",(0,i.jsx)(r.h3,{id:"api-surface",children:"API surface"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.strong,{children:(0,i.jsx)(r.code,{children:"createWrappedGrpc(clientGrpc: ClientGrpc, options?: GrpcOptions): WrappedGrpc"})})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.strong,{children:(0,i.jsx)(r.code,{children:"new WrappedGrpc(clientGrpc: ClientGrpc, options?: GrpcOptions)"})})}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:(0,i.jsx)(r.code,{children:"getService<T>(name: string): T"})})," \u2014 tr\u1ea3 v\u1ec1 service nh\u01b0 ",(0,i.jsx)(r.code,{children:"ClientGrpc.getService"}),", nh\u01b0ng c\xe1c method Observable s\u1ebd \u0111\u01b0\u1ee3c wrap."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:(0,i.jsx)(r.code,{children:"getClientByServiceName<T>(name: string): T"})})," \u2014 passthrough."]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"grpcoptions",children:"GrpcOptions"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Option"}),(0,i.jsx)(r.th,{children:"Type"}),(0,i.jsx)(r.th,{children:"M\u1eb7c \u0111\u1ecbnh"}),(0,i.jsx)(r.th,{children:"M\xf4 t\u1ea3"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"enableLogging"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"boolean"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"true"})}),(0,i.jsx)(r.td,{children:"B\u1eadt/t\u1eaft log khi g\u1ecdi method gRPC (args \u0111\u01b0\u1ee3c sanitize)."})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"timeout"})}),(0,i.jsxs)(r.td,{children:[(0,i.jsx)(r.code,{children:"number"})," (ms)"]}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"30000"})}),(0,i.jsxs)(r.td,{children:["\xc1p ",(0,i.jsx)(r.code,{children:"rxjs timeout"}),". >0 th\xec b\u1eadt; 0 ho\u1eb7c undefined s\u1ebd b\u1ecf qua."]})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"retry"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"number"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"0"})}),(0,i.jsxs)(r.td,{children:["S\u1ed1 l\u1ea7n retry khi l\u1ed7i c\xf3 ",(0,i.jsx)(r.code,{children:"code"})," thu\u1ed9c ",(0,i.jsx)(r.code,{children:"retryableCodes"}),"."]})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"maxRetryDelay"})}),(0,i.jsxs)(r.td,{children:[(0,i.jsx)(r.code,{children:"number"})," (ms)"]}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"10000"})}),(0,i.jsxs)(r.td,{children:["Tr\u1ea7n delay cho exponential backoff: ",(0,i.jsx)(r.code,{children:"min(1000 * 2^retryCount, maxRetryDelay)"}),"."]})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"retryableCodes"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"number[]"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"[1,4,8,10,13,14,15]"})}),(0,i.jsx)(r.td,{children:"Danh s\xe1ch gRPC status codes s\u1ebd \u0111\u01b0\u1ee3c ph\xe9p retry."})]})]})]}),"\n",(0,i.jsx)(r.admonition,{type:"note",children:(0,i.jsxs)(r.p,{children:["Backoff s\u1eed d\u1ee5ng ",(0,i.jsx)(r.code,{children:"Math.min(1000 * Math.pow(2, retryCount), maxRetryDelay)"}),". V\xed d\u1ee5: 1s \u2192 2s \u2192 4s \u2192 ... capped b\u1edfi ",(0,i.jsx)(r.code,{children:"maxRetryDelay"}),"."]})}),"\n",(0,i.jsx)(r.h3,{id:"error-model-grpcclientexception",children:"Error model: GrpcClientException"}),"\n",(0,i.jsxs)(r.p,{children:["M\u1ecdi l\u1ed7i sau khi qua ",(0,i.jsx)(r.code,{children:"catchError"})," s\u1ebd n\xe9m ",(0,i.jsx)(r.code,{children:"GrpcClientException"})," v\u1edbi c\xe1c field:"]}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Field"}),(0,i.jsx)(r.th,{children:"Type"}),(0,i.jsx)(r.th,{children:"M\xf4 t\u1ea3"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"message"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"string"})}),(0,i.jsx)(r.td,{children:"Th\xf4ng \u0111i\u1ec7p l\u1ed7i."})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"code"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"number?"})}),(0,i.jsx)(r.td,{children:"gRPC status code (n\u1ebfu c\xf3)."})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"details"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"unknown?"})}),(0,i.jsx)(r.td,{children:"Th\xf4ng tin chi ti\u1ebft (string ho\u1eb7c object)."})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"metadata"})}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"unknown?"})}),(0,i.jsx)(r.td,{children:"Metadata gRPC (n\u1ebfu \u0111\u01b0\u1ee3c \u0111\xednh k\xe8m)."})]})]})]}),"\n",(0,i.jsx)(r.admonition,{type:"warning",children:(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"retry"})," ch\u1ec9 \xe1p d\u1ee5ng khi l\u1ed7i c\xf3 ",(0,i.jsx)(r.code,{children:"code"})," v\xe0 n\u1eb1m trong ",(0,i.jsx)(r.code,{children:"retryableCodes"}),". N\u1ebfu kh\xf4ng, l\u1ed7i \u0111\u01b0\u1ee3c throw ngay."]})}),"\n",(0,i.jsx)(r.h3,{id:"v\xed-d\u1ee5-s\u1eed-d\u1ee5ng",children:"V\xed d\u1ee5 s\u1eed d\u1ee5ng"}),"\n",(0,i.jsxs)(s.A,{children:[(0,i.jsx)(l.A,{value:"setup",label:"Setup trong Module",children:(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"// user.module.ts\nimport { Module } from '@nestjs/common';\nimport { ClientsModule, Transport } from '@nestjs/microservices';\nimport { join } from 'path';\n\n@Module({\n    imports: [\n        ClientsModule.register([\n            {\n                name: 'USER_GRPC_CLIENT',\n                transport: Transport.GRPC,\n                options: {\n                    package: 'user',\n                    protoPath: join(__dirname, '../proto/user.proto'),\n                    url: 'localhost:50051',\n                },\n            },\n        ]),\n    ],\n    providers: [UserService],\n    exports: [UserService],\n})\nexport class UserModule {}\n"})})}),(0,i.jsx)(l.A,{value:"service",label:"Service Implementation",children:(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"// user.service.ts\nimport { Injectable, Inject } from '@nestjs/common';\nimport { ClientGrpc } from '@nestjs/microservices';\nimport { createWrappedGrpc, WrappedGrpc } from '@ecom-co/grpc';\nimport { firstValueFrom, Observable } from 'rxjs';\n\ninterface UserGrpcService {\n    getUser(data: { id: string }): Observable<any>;\n    createUser(data: any): Observable<any>;\n    updateUser(data: any): Observable<any>;\n}\n\n@Injectable()\nexport class UserService {\n    private grpc: WrappedGrpc;\n    private userService: UserGrpcService;\n\n    constructor(@Inject('USER_GRPC_CLIENT') private readonly client: ClientGrpc) {\n        this.grpc = createWrappedGrpc(this.client, {\n            enableLogging: true,\n            timeout: 15000, // 15 seconds\n            retry: 3,\n            maxRetryDelay: 5000,\n            retryableCodes: [1, 4, 8, 10, 13, 14, 15], // CANCELLED, DEADLINE_EXCEEDED, etc.\n        });\n    }\n\n    onModuleInit() {\n        this.userService = this.grpc.getService<UserGrpcService>('UserService');\n    }\n\n    async findById(id: string) {\n        try {\n            return await firstValueFrom(this.userService.getUser({ id }));\n        } catch (error) {\n            // error s\u1ebd l\xe0 GrpcClientException, s\u1ebd \u0111\u01b0\u1ee3c GrpcClientFilter x\u1eed l\xfd\n            throw error;\n        }\n    }\n\n    async create(userData: any) {\n        return firstValueFrom(this.userService.createUser(userData));\n    }\n}\n"})})}),(0,i.jsx)(l.A,{value:"controller",label:"Controller Usage",children:(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"// user.controller.ts\nimport { Controller, Get, Post, Body, Param } from '@nestjs/common';\nimport { UserService } from './user.service';\n\n@Controller('users')\nexport class UserController {\n    constructor(private readonly userService: UserService) {}\n\n    @Get(':id')\n    async getUser(@Param('id') id: string) {\n        // N\u1ebfu gRPC service l\u1ed7i, GrpcClientFilter s\u1ebd t\u1ef1 \u0111\u1ed9ng convert th\xe0nh HTTP response\n        return this.userService.findById(id);\n    }\n\n    @Post()\n    async createUser(@Body() userData: any) {\n        return this.userService.create(userData);\n    }\n}\n"})})}),(0,i.jsx)(l.A,{value:"observable",label:"Observable Pattern",children:(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"// S\u1eed d\u1ee5ng Observable tr\u1ef1c ti\u1ebfp\nconst user$ = userService.getUser({ id: '123' });\nuser$.subscribe({\n    next: (u) => console.log(u),\n    error: (e) => console.error(e), // e instanceof GrpcClientException\n});\n\n// Ho\u1eb7c convert th\xe0nh Promise\nconst user = await firstValueFrom(userService.getUser({ id: '123' }));\n"})})}),(0,i.jsx)(l.A,{value:"advanced",label:"Advanced Configuration",children:(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"// C\u1ea5u h\xecnh n\xe2ng cao cho production\nconst grpc = createWrappedGrpc(clientGrpc, {\n    enableLogging: process.env.NODE_ENV !== 'production',\n    timeout: 30000, // 30s cho operations ph\u1ee9c t\u1ea1p\n    retry: 2, // \xcdt retry h\u01a1n \u0111\u1ec3 tr\xe1nh cascade failure\n    maxRetryDelay: 8000,\n    retryableCodes: [\n        1, // CANCELLED - client cancel\n        4, // DEADLINE_EXCEEDED - timeout\n        8, // RESOURCE_EXHAUSTED - rate limit\n        14, // UNAVAILABLE - service down\n    ],\n});\n\n// S\u1eed d\u1ee5ng v\u1edbi error handling chi ti\u1ebft\ntry {\n    const result = await firstValueFrom(service.complexOperation(data));\n    return result;\n} catch (error) {\n    if (error.code === 5) {\n        // NOT_FOUND\n        throw new NotFoundException('Resource not found');\n    }\n    // C\xe1c l\u1ed7i kh\xe1c \u0111\u1ec3 GrpcClientFilter x\u1eed l\xfd\n    throw error;\n}\n"})})})]}),"\n",(0,i.jsx)(r.h3,{id:"logging--sanitize-args",children:"Logging & sanitize args"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:'// C\xe1c field sau s\u1ebd b\u1ecb thay b\u1eb1ng "[REDACTED]" trong log: password, token, secret, key\nthis.logger.debug(`Calling gRPC method: ${service}.${method}`, { args: sanitizedArgs });\n'})}),"\n",(0,i.jsx)(r.h3,{id:"mermaid-retry--timeout-pipeline",children:"Mermaid: Retry & Timeout pipeline"}),"\n",(0,i.jsx)(r.mermaid,{value:"flowchart TD\n  A[Observable t\u1eeb ClientGrpc] --\x3e B{timeout > 0?}\n  B -- No --\x3e C\n  B -- Yes --\x3e C[apply timeout ms]\n  C --\x3e D{retry > 0?}\n  D -- No --\x3e E[catchError throw GrpcClientException]\n  D -- Yes --\x3e F[retryIf code retryableCodes with exp backoff]\n  F --\x3e E"}),"\n",(0,i.jsx)(r.h3,{id:"best-practices",children:"Best practices"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"\u0110\u1eb7t timeout"})," ph\xf9 h\u1ee3p v\u1edbi SLA c\u1ee7a service."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Gi\u1edbi h\u1ea1n retry"})," \u0111\u1ec3 tr\xe1nh g\xe2y load d\u1ed3n khi downstream g\u1eb7p s\u1ef1 c\u1ed1."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"K\u1ebft h\u1ee3p GrpcClientFilter"})," \u1edf HTTP layer \u0111\u1ec3 mapping l\u1ed7i gRPC \u2192 HTTP chu\u1ea9n."]}),"\n"]})]})}function u(e={}){const{wrapper:r}={...(0,c.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}}}]);